<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDFC Payment Chrome Error Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #218838;
        }
        .error-btn {
            background: #dc3545;
        }
        .error-btn:hover {
            background: #c82333;
        }
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ HDFC Payment Chrome Error Fix Test</h1>
        
        <div class="test-section">
            <h2>Issue: chrome-error://chromewebdata/ 404 Error</h2>
            <p><strong>Problem:</strong> When clicking HDFC payment option, getting chrome-error://chromewebdata/:1 Failed to load resource error</p>
            <p><strong>Root Cause:</strong> Using window.open('', '_self') to write redirect form HTML</p>
            <p><strong>Solution:</strong> Use document.open() and document.write() to replace current page content</p>
        </div>

        <div class="test-section">
            <h2>Test HDFC Payment Flow</h2>
            <p>Click the button below to test the fixed HDFC payment redirection:</p>
            
            <button onclick="testHDFCPayment()">Test HDFC Payment (Fixed)</button>
            <button onclick="testOldMethod()" class="error-btn">Test Old Method (Chrome Error)</button>
            
            <div id="log" class="log">Ready to test HDFC payment flow...\n</div>
        </div>

        <div class="test-section">
            <h2>Expected Results</h2>
            <ul>
                <li>‚úÖ Fixed method: Should redirect to HDFC UAT gateway without chrome-error</li>
                <li>‚ùå Old method: Will show chrome-error://chromewebdata/ 404 error</li>
                <li>üîÑ Auto-redirect: Page should automatically submit to HDFC within 3 seconds</li>
                <li>üè¶ Gateway: Should reach smartgatewayuat.hdfcbank.com</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testHDFCPayment() {
            log('üîÑ Testing HDFC payment with fixed method...');
            
            try {
                // Simulate API call to get HDFC form
                log('üì° Calling HDFC create order API...');
                
                const testOrderData = {
                    amount: 100.00,
                    productinfo: "Test Order - Chrome Error Fix",
                    firstname: "Test",
                    lastname: "Customer", 
                    email: "test@example.com",
                    phone: "9999999999",
                    address: "Test Address",
                    city: "Test City",
                    state: "Test State",
                    pincode: "123456"
                };

                const response = await fetch('https://textilesbackend.vercel.app/api/hdfc-create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testOrderData)
                });

                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }

                const hdfcData = await response.json();
                log('‚úÖ HDFC API response received');
                log(`üìã Order ID: ${hdfcData.order_id}`);
                log(`üí∞ Amount: ‚Çπ${hdfcData.payment_data.amount}`);

                if (hdfcData.success && hdfcData.redirect_form) {
                    log('üîÑ Using fixed method: document.open() + document.write()');
                    log('üè¶ Redirecting to HDFC payment gateway...');
                    
                    // Use the fixed method - replace current document content
                    setTimeout(() => {
                        document.open();
                        document.write(hdfcData.redirect_form);
                        document.close();
                    }, 2000);
                    
                } else {
                    throw new Error('Invalid HDFC response');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                console.error('HDFC Test Error:', error);
            }
        }

        function testOldMethod() {
            log('üîÑ Testing old method that causes chrome-error...');
            log('‚ö†Ô∏è This will demonstrate the chrome-error issue');
            
            try {
                // Simulate the old problematic method
                const testForm = '<!DOCTYPE html>' +
                    '<html><head><title>Test</title></head>' +
                    '<body>' +
                        '<h1>This will cause chrome-error://chromewebdata/</h1>' +
                        '<form id="testForm" action="https://smartgatewayuat.hdfcbank.com/merchant/ipay" method="POST">' +
                            '<input type="hidden" name="test" value="old_method" />' +
                        '</form>' +
                        '<' + 'script>document.getElementById("testForm").submit();<' + '/script>' +
                    '</body>' +
                    '</html>';
                
                log('‚ùå Using problematic method: window.open() + document.write()');
                
                setTimeout(() => {
                    // This is the old method that causes chrome-error
                    const newWindow = window.open('', '_self');
                    newWindow.document.write(testForm);
                    newWindow.document.close();
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Error (Expected): ${error.message}`);
            }
        }

        // Page load
        log('üöÄ Test page loaded successfully');
        log('üí° Click "Test HDFC Payment (Fixed)" to test the chrome-error fix');
    </script>
</body>
</html>